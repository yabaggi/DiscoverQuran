<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>مع القرآن الكريم</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap');
body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;padding:0;direction:rtl}
.hero{position:relative;height:260px;background-image:url('heroimage.jpg'),url('https://images.unsplash.com/photo-1519817650390-64a93db51149?auto=format&fit=crop&q=80&w=1200');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;color:#fff;text-align:center}
.hero::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,0.55)}
.hero-content{position:relative;z-index:2}
.hero h1{font-size:2.4rem;margin:0}
.app-container{max-width:900px;background:#fff;margin:20px auto;border-radius:12px;padding:20px;box-shadow:0 6px 22px rgba(0,0,0,0.06)}
select{width:100%;padding:12px;font-size:18px;border:1px solid #ccc;border-radius:6px;background:#fff;margin-bottom:12px;text-align:center;appearance:none}
.ayah-row{display:flex;align-items:center;gap:8px}
.ayah-row select{flex:1;margin-bottom:0}
#ayah-decrement,#ayah-increment{width:108px;height:42px;font-size:20px;border:none;border-radius:8px;background:#1976d2;color:#fff;cursor:pointer}
#ayah-decrement:disabled,#ayah-increment:disabled{background:#9aa6bf;cursor:not-allowed}
.font-controls{display:flex;justify-content:center;align-items:center;gap:10px;margin:14px 0}
.font-controls button{padding:8px 14px;font-size:16px;background:#1976d2;color:#fff;border:none;border-radius:6px;cursor:pointer}
#font-size-label{color:#333}
.quran-text-card{border:1px solid #e6e9ef;border-radius:10px;background:#fff;padding:16px;margin-bottom:16px}
.quran-text{direction:rtl;text-align:right;font-family:'Scheherazade New',serif;font-size:16px;line-height:2;word-wrap:break-word;padding-bottom:12px}
.translations{direction:ltr;text-align:left;font-size:16px;border-top:1px solid #f1f3f4;padding-top:12px;color:#222}
#urdu{border-top:1px solid #eee;margin-top:12px;padding-top:12px}
.chips-section{margin-top:20px}
.chips-title{text-align:center;font-size:16px;font-weight:600;color:#333;margin-bottom:12px}
.chips-container{display:flex;overflow-x:auto;gap:8px;padding:0 8px;scrollbar-width:none}
.chips-container::-webkit-scrollbar{display:none}
.chip{display:inline-flex;align-items:center;background:#f1f3f4;border:1px solid #dadce0;border-radius:20px;padding:8px 16px;font-size:14px;color:#3c4043;white-space:nowrap;transition:all .15s;cursor:pointer}
.chip:hover{background:#e8f0fe;color:#1a73e8;border-color:#1a73e8}
.chip.active{background:#1a73e8;color:#fff;border-color:#1a73e8}
.tafsir-content-box{margin-top:12px;padding:14px;border-radius:8px;background:#fafafa;border:1px solid #eee;line-height:1.7;font-size:16px;color:#222;min-height:64px;position:relative}
.tafsir-header{font-weight:700;margin-bottom:8px;font-size:17px;color:#222}
.copy-btn{position:absolute;top:12px;left:12px;background:#1976d2;color:#fff;border:none;padding:6px 10px;border-radius:6px;font-size:13px;cursor:pointer}
.copy-btn:hover{background:#125ab2}
.status{text-align:center;color:#b00020;font-size:14px;margin-top:8px}
audio{width:100%;margin-top:10px}
#loop-container{display:flex;align-items:center;gap:8px;justify-content:center;margin:10px 0;font-size:15px}
#reciter-info{text-align:center;font-size:15px;color:#333;margin-top:8px;display:none}
</style>
</head>
<body>

<div class="hero">
  <div class="hero-content">
    <h1>مع القرآن الكريم</h1>
    <p>استكشف القرآن بالترجمة والتلاوة والتفسير</p>
  </div>
</div>

<div class="app-container">
  <select id="surah-select"><option value="">إختار السورة</option></select>

  <div class="ayah-row">
    <select id="ayah-select" disabled><option value="">اختر الآية</option></select>
    <button id="ayah-decrement" disabled>-</button>
    <button id="ayah-increment" disabled>+</button>
  </div>

  <div class="font-controls">
    <button id="font-smaller">A-</button>
    <button id="font-bigger">A+</button>
    <span id="font-size-label">16px</span>
  </div>

  <div class="quran-text-card">
    <div id="arabic-text" class="quran-text"></div>
    <div class="translations"><div id="english"></div><div id="urdu"></div></div>
  </div>

  <div id="loop-container">
    <input type="checkbox" id="play-next10">
    <label for="play-next10">تلاوة الآيات العشرة التالية أو إلى نهاية السورة</label>
  </div>

  <div class="chips-section">
    <div class="chips-title">إختيار القارئ</div>
    <div class="chips-container" id="reciters-container">
      <div class="chip reciter-chip" data-id="1" data-name="مشاري الفارسي">مشاري الفارسي</div>
      <div class="chip reciter-chip" data-id="2" data-name="ابوبكر الشاطري">ابوبكر الشاطري</div>
      <div class="chip reciter-chip" data-id="3" data-name="ناصر القتمي">ناصر القتمي</div>
      <div class="chip reciter-chip" data-id="4" data-name="ياسر الدوسري">ياسر الدوسري</div>
      <div class="chip reciter-chip" data-id="5" data-name="هانى الرفاعي">هانى الرفاعي</div>
    </div>
  </div>

  <div id="reciter-info"></div>
  <audio id="audio-player" controls style="display:none"></audio>

  <div class="chips-section">
    <div class="chips-title">إختيار التفسير</div>
    <div class="chips-container" id="tafsir-authors"></div>

    <div id="tafsir-text" class="tafsir-content-box">
      <div id="tafsir-header" class="tafsir-header"></div>
      <button class="copy-btn" id="copy-tafsir">📋 نسخ</button>
      <div id="tafsir-body">اختر مؤلفا لعرض التفسير هنا..</div>
    </div>
  </div>

  <div class="status" id="status"></div>
</div>

<script>
const SURAH_URL='https://quranapi.pages.dev/api/surah.json';
const surahSelect=document.getElementById('surah-select');
const ayahSelect=document.getElementById('ayah-select');
const ayahDec=document.getElementById('ayah-decrement');
const ayahInc=document.getElementById('ayah-increment');
const arabicEl=document.getElementById('arabic-text');
const englishEl=document.getElementById('english');
const urduEl=document.getElementById('urdu');
const tafsirAuthorsEl=document.getElementById('tafsir-authors');
const tafsirHeader=document.getElementById('tafsir-header');
const tafsirBody=document.getElementById('tafsir-body');
const copyBtn=document.getElementById('copy-tafsir');
const audioPlayer=document.getElementById('audio-player');
const playNext10=document.getElementById('play-next10');
const statusEl=document.getElementById('status');
const reciterInfo=document.getElementById('reciter-info');

let currentAudioData=null,selectedReciterId=null,selectedReciterName='',currentFontSize=16,ibnKathirId=null,surahNames=[],totalAyahs=0;
let isSequentialPlaying=false,stopSequential=false;

async function fetchJSON(u){const r=await fetch(u);if(!r.ok)throw new Error(r.status);return r.json();}

async function loadSurahs(){
  const d=await fetchJSON(SURAH_URL);
  surahNames=d.map(x=>x.surahNameArabic);
  d.forEach((s,i)=>{const o=document.createElement('option');o.value=i+1;o.textContent=`${i+1}. ${s.surahNameArabic}`;surahSelect.appendChild(o);});
}

async function loadTafsirAuthors(){
  try{
    const arr=await fetchJSON('https://api.quran-tafseer.com/tafseer/');
    const filtered=arr.filter(a=>a.language==='ar'||a.language==='en');
    const order=['تفسير الجلالين','تفسير ابن كثير','التفسير الميسر','تفسير السعدي'];
    const prioritized=[],rest=[];
    filtered.forEach(a=>{if(order.includes(a.name.trim()))prioritized.push(a);else rest.push(a);});
    prioritized.sort((a,b)=>order.indexOf(a.name.trim())-order.indexOf(b.name.trim()));
    const finalList=[...prioritized,...rest];
    tafsirAuthorsEl.innerHTML='';
    finalList.forEach(a=>{
      const chip=document.createElement('div');
      chip.className='chip tafsir-chip';
      chip.textContent=a.name;
      chip.dataset.id=a.id;
      chip.addEventListener('click',()=>selectTafsir(a.id,a.name,chip));
      tafsirAuthorsEl.appendChild(chip);
      if(a.name.trim()==='تفسير ابن كثير')ibnKathirId=a.id;
    });
  }catch(e){
    tafsirAuthorsEl.innerHTML='<div style="color:#888;text-align:center;padding:10px">فشل تحميل المفسرين</div>';
  }
}

surahSelect.addEventListener('change',async()=>{
 const s=parseInt(surahSelect.value);if(!s)return;
 const meta=await fetchJSON(`https://quranapi.pages.dev/api/${s}/1.json`);
 totalAyahs=meta.totalAyah;ayahSelect.innerHTML='';
 for(let i=1;i<=totalAyahs;i++){const o=document.createElement('option');o.value=i;o.textContent=i;ayahSelect.appendChild(o);}
 ayahSelect.disabled=false;ayahSelect.value=1;updateAyahButtons();loadAyah();
});

ayahSelect.addEventListener('change',()=>{loadAyah();updateAyahButtons();});
ayahDec.onclick=()=>{let v=parseInt(ayahSelect.value);if(v>1){ayahSelect.value=v-1;loadAyah();}updateAyahButtons();};
ayahInc.onclick=()=>{let v=parseInt(ayahSelect.value);const m=ayahSelect.options.length;if(v<m){ayahSelect.value=v+1;loadAyah();}updateAyahButtons();};
function updateAyahButtons(){const a=parseInt(ayahSelect.value),m=ayahSelect.options.length;ayahDec.disabled=a<=1;ayahInc.disabled=a>=m;}

async function loadAyah(){
 const s=parseInt(surahSelect.value),a=parseInt(ayahSelect.value);
 if(!s||!a)return;
 const d=await fetchJSON(`https://quranapi.pages.dev/api/${s}/${a}.json`);
 arabicEl.textContent=d.arabic1||'';englishEl.textContent=d.english||'';urduEl.textContent=d.urdu||'';currentAudioData=d.audio||null;
 if(ibnKathirId) loadIbnKathir(s,a);
}

async function loadIbnKathir(surah,ayah){
 tafsirHeader.textContent=`تفسير ابن كثير (${surahNames[surah-1]} – رقم الآية ${ayah})`;
 tafsirBody.textContent='...جاري تحميل التفسير';
 document.querySelectorAll('.tafsir-chip').forEach(c=>c.classList.remove('active'));
 const ibnChip=[...document.querySelectorAll('.tafsir-chip')].find(c=>c.textContent.trim()==='تفسير ابن كثير');
 if(ibnChip) ibnChip.classList.add('active');
 const d=await fetchJSON(`https://api.quran-tafseer.com/tafseer/${ibnKathirId}/${surah}/${ayah}`);
 tafsirBody.textContent=d.text||'لم يتم العثور على تفسير ابن كثير';
}

copyBtn.onclick=()=>{const title=tafsirHeader.textContent.trim(),text=tafsirBody.textContent.trim();if(!text)return;navigator.clipboard.writeText(`${title}\n\n${text}`).then(()=>{copyBtn.textContent='✅ تم النسخ';setTimeout(()=>copyBtn.textContent='📋 نسخ',2000);});};

document.getElementById('font-bigger').onclick=()=>{currentFontSize=Math.min(60,currentFontSize+2);arabicEl.style.fontSize=currentFontSize+'px';document.getElementById('font-size-label').textContent=currentFontSize+'px';};
document.getElementById('font-smaller').onclick=()=>{currentFontSize=Math.max(14,currentFontSize-2);arabicEl.style.fontSize=currentFontSize+'px';document.getElementById('font-size-label').textContent=currentFontSize+'px';};

document.querySelectorAll('.reciter-chip').forEach(c=>{
 c.addEventListener('click',async()=>{
  if(isSequentialPlaying){stopSequential=true;await new Promise(r=>setTimeout(r,300));}
  document.querySelectorAll('.reciter-chip').forEach(x=>x.classList.remove('active'));
  c.classList.add('active');
  selectedReciterId=c.dataset.id;selectedReciterName=c.dataset.name;
  reciterInfo.textContent=`التلاوة بصوت القارئ ${selectedReciterName}`;
  reciterInfo.style.display='block';
  if(!currentAudioData){statusEl.textContent='لا يوجد صوت';return;}
  stopSequential=false;
  if(playNext10.checked){isSequentialPlaying=true;await playSequentialAyahs(selectedReciterId);isSequentialPlaying=false;}
  else playSingleAyah(selectedReciterId);
 });
});

playNext10.addEventListener('change',()=>{if(!playNext10.checked&&isSequentialPlaying){stopSequential=true;audioPlayer.pause();isSequentialPlaying=false;reciterInfo.style.display='none';}});

function playSingleAyah(recId){
 const val=currentAudioData[recId];
 if(val&&val.url){audioPlayer.src=val.url;audioPlayer.style.display='block';audioPlayer.play().catch(()=>{});}
 else statusEl.textContent='لا يوجد صوت لهذا القارئ';
}

async function playSequentialAyahs(recId){
 const s=parseInt(surahSelect.value),a=parseInt(ayahSelect.value);
 let start=a,end=Math.min(a+9,totalAyahs);
 for(let n=start;n<=end;n++){if(stopSequential){reciterInfo.style.display='none';return;}
 ayahSelect.value=n;await loadAyah();const data=await fetchJSON(`https://quranapi.pages.dev/api/${s}/${n}.json`);
 const aud=data.audio;if(!aud)break;const v=aud[recId];
 if(v&&v.url){audioPlayer.src=v.url;audioPlayer.style.display='block';try{await audioPlayer.play();}catch{}await new Promise(res=>audioPlayer.onended=res);}else break;}
 reciterInfo.style.display='none';
}

async function selectTafsir(id,name,chip){
 const s=parseInt(surahSelect.value),a=parseInt(ayahSelect.value);
 if(!s||!a){tafsirBody.textContent='اختر السورة والآية أولاً';return;}
 document.querySelectorAll('.tafsir-chip').forEach(c=>c.classList.remove('active'));chip.classList.add('active');
 tafsirHeader.textContent=`${name} (${surahNames[s-1]} – رقم الآية ${a})`;tafsirBody.textContent='...جار التحميل';
 const d=await fetchJSON(`https://api.quran-tafseer.com/tafseer/${id}/${s}/${a}`);tafsirBody.textContent=d.text||'لم يتم العثور على التفسير';
}

loadSurahs();loadTafsirAuthors();
</script>
</body>
</html>
